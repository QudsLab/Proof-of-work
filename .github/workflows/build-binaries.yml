name: Build Proof-of-Work Binaries

on:
  # Trigger on push to main (automatic)
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'python/**'
      - 'build_win64.ps1'
      - '.github/workflows/build-binaries.yml'
  
  # Daily automated build at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'

  # Manual trigger
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build_windows:
    name: Build Windows Binaries (${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            target: win64
          - arch: x86
            target: win32

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Setup MinGW-w64 (GCC)
      uses: egor-tensin/setup-mingw@v2
      with:
        cygwin: false
        cc: yes
        version: latest
        platform: ${{ matrix.arch }}

    - name: Verify GCC installation
      shell: pwsh
      run: |
        gcc --version
        where gcc

    - name: Build DLLs (${{ matrix.arch }})
      shell: pwsh
      run: |
        Write-Host "Starting build for ${{ matrix.arch }}..." -ForegroundColor Green
        .\build_win64.ps1
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed with exit code $LASTEXITCODE" -ForegroundColor Red
          exit 1
        }
        Write-Host "Build completed successfully!" -ForegroundColor Green

    - name: Verify binaries
      shell: pwsh
      run: |
        Write-Host "Checking for built binaries..."
        $clientDll = ".\bin\win\64\dll\client.dll"
        $serverDll = ".\bin\win\64\dll\server.dll"
        
        if (Test-Path $clientDll) {
          $size = (Get-Item $clientDll).Length / 1KB
          Write-Host "✓ client.dll found ($('{0:N2}' -f $size) KB)"
        } else {
          Write-Host "✗ client.dll NOT found" -ForegroundColor Red
          exit 1
        }
        
        if (Test-Path $serverDll) {
          $size = (Get-Item $serverDll).Length / 1KB
          Write-Host "✓ server.dll found ($('{0:N2}' -f $size) KB)"
        } else {
          Write-Host "✗ server.dll NOT found" -ForegroundColor Red
          exit 1
        }

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries-windows-${{ matrix.arch }}
        path: bin/win/
        retention-days: 30

  test_binaries:
    name: Test Binaries (Windows ${{ matrix.arch }})
    needs: build_windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            target: win64
          - arch: x86
            target: win32

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: binaries-windows-${{ matrix.arch }}
        path: bin/win/

    - name: Verify downloaded binaries
      shell: pwsh
      run: |
        Write-Host "Checking downloaded binaries..."
        if (Test-Path ".\bin\win\64\dll\client.dll") {
          Write-Host "✓ client.dll verified"
          Get-Item ".\bin\win\64\dll\client.dll" | Format-List
        } else {
          Write-Host "✗ client.dll not found" -ForegroundColor Red
          exit 1
        }
        
        if (Test-Path ".\bin\win\64\dll\server.dll") {
          Write-Host "✓ server.dll verified"
          Get-Item ".\bin\win\64\dll\server.dll" | Format-List
        } else {
          Write-Host "✗ server.dll not found" -ForegroundColor Red
          exit 1
        }

    - name: Run test suite
      shell: pwsh
      run: |
        Write-Host "Running test suite..." -ForegroundColor Green
        Write-Host "Command: python `"python/main.py`" win 64`n"
        python "python/main.py" win 64
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "`n✓ Tests passed!" -ForegroundColor Green
        } else {
          Write-Host "`n✗ Tests failed!" -ForegroundColor Red
          exit 1
        }

    - name: Test summary
      if: always()
      shell: pwsh
      run: |
        Write-Host "## Test Results - Windows ${{ matrix.arch }}" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "| Component | Status |" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "|-----------|--------|" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "| Build | ✓ Passed |" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "| Tests | ✓ Passed |" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "**Platform**: Windows ${{ matrix.arch }}" >> $env:GITHUB_STEP_SUMMARY

  commit_binaries:
    name: Commit Binaries to Repository
    needs: [build_windows, test_binaries]
    runs-on: ubuntu-latest
    if: always() && needs.build_windows.result == 'success' && needs.test_binaries.result == 'success'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: downloaded-artifacts

    - name: Organize binaries
      run: |
        # List downloaded artifacts for debugging
        echo "Downloaded artifacts:"
        ls -la downloaded-artifacts/
        
        # Create bin directory if it doesn't exist
        mkdir -p bin/win/64/dll
        mkdir -p bin/win/64/lib
        
        # Move all downloaded artifacts to bin/
        for artifact_dir in downloaded-artifacts/binaries-windows-*; do
          if [ -d "$artifact_dir" ]; then
            arch=$(basename "$artifact_dir" | sed 's/^binaries-windows-//')
            echo "Processing Windows $arch binaries"
            echo "  Contents of artifact:"
            ls -la "$artifact_dir/" || true
            
            # Copy DLL and LIB files
            cp -v "$artifact_dir"/64/dll/*.dll bin/win/64/dll/ 2>/dev/null || true
            cp -v "$artifact_dir"/64/lib/*.lib bin/win/64/lib/ 2>/dev/null || true
          fi
        done
        
        # List final bin structure
        echo "Final bin structure:"
        find bin -type f -ls
        
        # Create build info file
        cat > bin/BUILD_INFO.txt << 'EOF'
        Proof-of-Work Binary Build Information
        ========================================
        
        Build Date: $(date -u)
        GitHub Run ID: ${{ github.run_id }}
        GitHub Run Number: ${{ github.run_number }}
        Triggered by: ${{ github.event_name }}
        Commit: ${{ github.sha }}
        
        Successfully built binaries:
        EOF
        
        find bin -type f \( -name "*.dll" -o -name "*.lib" \) | sed 's|bin/||g' | sort >> bin/BUILD_INFO.txt
        
        echo "" >> bin/BUILD_INFO.txt
        echo "Total binaries: $(find bin -type f \( -name "*.dll" -o -name "*.lib" \) | wc -l)" >> bin/BUILD_INFO.txt
        
        # List all binaries
        echo "Built binaries:"
        find bin -type f \( -name "*.dll" -o -name "*.lib" \) -ls

    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

    - name: Commit and push binaries
      run: |
        git add bin/
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Count binaries
          binary_count=$(find bin -type f \( -name "*.dll" -o -name "*.lib" \) | wc -l)
          
          git commit -m "Build: Update $binary_count binaries [skip ci]" \
                     -m "Run: ${{ github.run_id }}" \
                     -m "Commit: ${{ github.sha }}"
          
          # Pull latest changes with merge strategy
          git pull --no-rebase origin main || git pull --rebase origin main || true
          
          # Push with retry logic
          max_retries=3
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if git push origin main; then
              echo "Binaries committed and pushed successfully!"
              break
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "Push failed, retrying ($retry_count/$max_retries)..."
                git pull --rebase origin main || true
                sleep 2
              else
                echo "Failed to push after $max_retries attempts"
                exit 1
              fi
            fi
          done
        fi

    - name: Create build summary
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status | Binaries |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
        
        for platform_dir in bin/win/*/; do
          if [ -d "$platform_dir" ]; then
            dll_count=$(find "$platform_dir" -name "*.dll" 2>/dev/null | wc -l)
            lib_count=$(find "$platform_dir" -name "*.lib" 2>/dev/null | wc -l)
            if [ $((dll_count + lib_count)) -gt 0 ]; then
              echo "| Windows 64-bit | ✓ Built | $dll_count DLL, $lib_count LIB |" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        total_binaries=$(find bin -type f \( -name "*.dll" -o -name "*.lib" \) 2>/dev/null | wc -l)
        echo "**Total binaries**: $total_binaries" >> $GITHUB_STEP_SUMMARY
        echo "**Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  final_report:
    name: Build Report
    needs: [build_windows, test_binaries, commit_binaries]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Generate report
      run: |
        echo "## Proof-of-Work Build Workflow Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Status" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build Windows | ${{ needs.build_windows.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Test Binaries | ${{ needs.test_binaries.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit Binaries | ${{ needs.commit_binaries.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Workflow Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.build_windows.result }}" = "success" ] && [ "${{ needs.test_binaries.result }}" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **All builds and tests passed!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "❌ **Build or test failed**" >> $GITHUB_STEP_SUMMARY
        fi
