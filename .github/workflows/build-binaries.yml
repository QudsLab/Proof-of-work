name: Build Multi-Platform Binaries

on:
  push:
    branches: [main]
    paths: ['src/**', 'python/**', 'build_win64.ps1', '.github/workflows/build-binaries.yml']
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_windows:
    name: Build Windows (${{ matrix.arch }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            variant: 64
          - arch: x86
            variant: 32
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: choco install mingw -y --no-progress
      - run: gcc --version
      - run: .\build_win64.ps1
        shell: pwsh
      - run: |
          if (!(Test-Path ".\bin\win\${{ matrix.variant }}\dll\client.dll")) { exit 1 }
          if (!(Test-Path ".\bin\win\${{ matrix.variant }}\dll\server.dll")) { exit 1 }
        shell: pwsh
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-windows-${{ matrix.arch }}
          path: bin/win/${{ matrix.variant }}/
          retention-days: 1

  build_linux:
    name: Build Linux (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            variant: 64
          - arch: aarch64
            variant: arm64
    steps:
      - uses: actions/checkout@v4
      - run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
          mkdir -p bin/linux/${{ matrix.variant }}/lib bin/linux/${{ matrix.variant }}/include
          HASH_SOURCES=$(find src/crypto -name "*.c" | tr '\n' ' ')
          INCLUDE_DIRS=$(find src/crypto -type d | sed 's/^/-I/' | tr '\n' ' ')
          gcc -shared -fPIC -o bin/linux/${{ matrix.variant }}/lib/libclient.so src/client.c $HASH_SOURCES -Isrc $INCLUDE_DIRS
          gcc -shared -fPIC -o bin/linux/${{ matrix.variant }}/lib/libserver.so src/server.c $HASH_SOURCES -Isrc $INCLUDE_DIRS
          cp src/export.h bin/linux/${{ matrix.variant }}/include/
          [ -f "bin/linux/${{ matrix.variant }}/lib/libclient.so" ] || exit 1
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-${{ matrix.arch }}
          path: bin/linux/${{ matrix.variant }}/
          retention-days: 1

  build_macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: macos-13
            variant: 64
          - arch: arm64
            runner: macos-latest
            variant: arm64
    steps:
      - uses: actions/checkout@v4
      - run: |
          mkdir -p bin/macos/${{ matrix.variant }}/lib bin/macos/${{ matrix.variant }}/include
          HASH_SOURCES=$(find src/crypto -name "*.c" | tr '\n' ' ')
          INCLUDE_DIRS=$(find src/crypto -type d | sed 's/^/-I/' | tr '\n' ' ')
          gcc -dynamiclib -fPIC -o bin/macos/${{ matrix.variant }}/lib/libclient.dylib src/client.c $HASH_SOURCES -Isrc $INCLUDE_DIRS
          gcc -dynamiclib -fPIC -o bin/macos/${{ matrix.variant }}/lib/libserver.dylib src/server.c $HASH_SOURCES -Isrc $INCLUDE_DIRS
          cp src/export.h bin/macos/${{ matrix.variant }}/include/
          [ -f "bin/macos/${{ matrix.variant }}/lib/libclient.dylib" ] || exit 1
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-macos-${{ matrix.arch }}
          path: bin/macos/${{ matrix.variant }}/
          retention-days: 1

  build_android:
    name: Build Android (${{ matrix.abi }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - abi: armeabi-v7a
            variant: armv7
          - abi: arm64-v8a
            variant: arm64
          - abi: x86
            variant: x86
          - abi: x86_64
            variant: x86_64
    steps:
      - uses: actions/checkout@v4
      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
      - run: |
          mkdir -p bin/android/${{ matrix.variant }}/lib bin/android/${{ matrix.variant }}/include
          NDK=$ANDROID_NDK_ROOT
          TC=$NDK/toolchains/llvm/prebuilt/linux-x86_64
          CC_CMD=$TC/bin
          case "${{ matrix.abi }}" in
            armeabi-v7a) CC=$CC_CMD/armv7a-linux-androideabi21-clang;;
            arm64-v8a) CC=$CC_CMD/aarch64-linux-android21-clang;;
            x86) CC=$CC_CMD/i686-linux-android21-clang;;
            x86_64) CC=$CC_CMD/x86_64-linux-android21-clang;;
          esac
          HASH_SOURCES=$(find src/crypto -name "*.c" | tr '\n' ' ')
          INCLUDE_DIRS=$(find src/crypto -type d | sed 's/^/-I/' | tr '\n' ' ')
          $CC -shared -fPIC -o bin/android/${{ matrix.variant }}/lib/libclient.so src/client.c $HASH_SOURCES -Isrc $INCLUDE_DIRS
          $CC -shared -fPIC -o bin/android/${{ matrix.variant }}/lib/libserver.so src/server.c $HASH_SOURCES -Isrc $INCLUDE_DIRS
          cp src/export.h bin/android/${{ matrix.variant }}/include/
          [ -f "bin/android/${{ matrix.variant }}/lib/libclient.so" ] || exit 1
      - uses: actions/upload-artifact@v4
        with:
          name: binaries-android-${{ matrix.abi }}
          path: bin/android/${{ matrix.variant }}/
          retention-days: 1

  organize_and_commit:
    name: Organize & Commit Binaries
    needs: [build_windows, build_linux, build_macos, build_android]
    runs-on: ubuntu-latest
    if: always() && (needs.build_windows.result == 'success' || needs.build_linux.result == 'success' || needs.build_macos.result == 'success' || needs.build_android.result == 'success')
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - run: python3 generate_metadata.py
      - run: find bin -type f | head -20
      - run: git config user.email "bot@github.com" && git config user.name "GitHub Bot"
      - run: |
          git add bin/
          if ! git diff --staged --quiet; then
            cnt=$(find bin -type f \( -name "*.dll" -o -name "*.so" -o -name "*.dylib" \) | wc -l)
            git commit -m "Build: Add $cnt binaries" -m "Run: ${{ github.run_id }}"
            git pull --rebase origin main || true
            git push origin main
          fi

  report:
    name: Build Report
    needs: [build_windows, build_linux, build_macos, build_android, organize_and_commit]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - run: |
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows | ${{ needs.build_windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Linux | ${{ needs.build_linux.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS | ${{ needs.build_macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android | ${{ needs.build_android.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ needs.organize_and_commit.result }} |" >> $GITHUB_STEP_SUMMARY
